/*!
 * Bootstrap v5.3.2 (https://getbootstrap.com/) - Custom Minimal Implementation
 * Copyright 2011-2023 The Bootstrap Authors
 * Licensed under MIT
 * Note: Minimal version for carousel functionality with enhanced debugging
 */
(function() {
    'use strict';
    
    console.log('?? Loading Bootstrap Carousel implementation...');
    
    // Ensure bootstrap namespace exists
    if (typeof window.bootstrap === 'undefined') {
        window.bootstrap = {};
        console.log('? Created Bootstrap namespace');
    }
    
    // Debug: Check if Carousel already exists
    if (window.bootstrap.Carousel) {
        console.log('?? Bootstrap.Carousel already exists, will override');
    }
    
    class Carousel {
        constructor(element, config = {}) {
            console.log('?? Creating new Carousel instance for:', element.id || 'unnamed element');
            
            this._element = element;
            this._config = Object.assign({
                interval: false,
                wrap: true,
                touch: true,
                keyboard: true
            }, config);
            this._activeIndex = 0;
            this._items = this._element.querySelectorAll('.carousel-item');
            
            console.log(`?? Carousel has ${this._items.length} items`);
            
            this._init();
        }
        
        static getInstance(element) {
            return element._carouselInstance || null;
        }
        
        static getOrCreateInstance(element, config) {
            const existing = this.getInstance(element);
            if (existing) {
                console.log('?? Returning existing carousel instance');
                return existing;
            }
            console.log('?? Creating new carousel instance');
            return new this(element, config);
        }
        
        _init() {
            this._element._carouselInstance = this;
            this._bindEvents();
            
            // Find active item
            const activeItem = this._element.querySelector('.carousel-item.active');
            if (activeItem) {
                this._activeIndex = Array.from(this._items).indexOf(activeItem);
                console.log(`?? Active slide index: ${this._activeIndex}`);
            }
            
            console.log('? Carousel initialized successfully');
        }
        
        _bindEvents() {
            // Controls
            const prevBtn = this._element.querySelector('.carousel-control-prev');
            const nextBtn = this._element.querySelector('.carousel-control-next');
            
            if (prevBtn) {
                prevBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('?? Previous button clicked');
                    this.prev();
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('?? Next button clicked');
                    this.next();
                });
            }
            
            // Indicators
            const indicators = this._element.querySelectorAll('.carousel-indicators [data-bs-slide-to]');
            indicators.forEach((indicator, index) => {
                indicator.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log(`?? Indicator ${index} clicked`);
                    this.to(index);
                });
            });
            
            console.log(`?? Events bound - Controls: ${prevBtn ? '?' : '?'} ${nextBtn ? '?' : '?'}, Indicators: ${indicators.length}`);
        }
        
        to(index) {
            if (index < 0 || index >= this._items.length) {
                console.warn(`?? Invalid slide index: ${index} (valid range: 0-${this._items.length - 1})`);
                return;
            }
            
            if (index === this._activeIndex) {
                console.log(`?? Already on slide ${index}`);
                return;
            }
            
            console.log(`?? Transitioning from slide ${this._activeIndex} to ${index}`);
            
            const slideEvent = new CustomEvent('slide.bs.carousel', {
                detail: { to: index, from: this._activeIndex }
            });
            this._element.dispatchEvent(slideEvent);
            
            // Remove active class from current item
            this._items[this._activeIndex].classList.remove('active');
            
            // Add active class to new item
            this._items[index].classList.add('active');
            
            // Update indicators
            const indicators = this._element.querySelectorAll('.carousel-indicators [data-bs-slide-to]');
            if (indicators.length > 0) {
                if (indicators[this._activeIndex]) {
                    indicators[this._activeIndex].classList.remove('active');
                    indicators[this._activeIndex].removeAttribute('aria-current');
                }
                if (indicators[index]) {
                    indicators[index].classList.add('active');
                    indicators[index].setAttribute('aria-current', 'true');
                }
            }
            
            this._activeIndex = index;
            
            const slidEvent = new CustomEvent('slid.bs.carousel', {
                detail: { to: index }
            });
            this._element.dispatchEvent(slidEvent);
            
            console.log(`? Transition complete - now on slide ${index}`);
        }
        
        next() {
            let nextIndex = this._activeIndex + 1;
            if (nextIndex >= this._items.length) {
                nextIndex = this._config.wrap ? 0 : this._activeIndex;
            }
            this.to(nextIndex);
        }
        
        prev() {
            let prevIndex = this._activeIndex - 1;
            if (prevIndex < 0) {
                prevIndex = this._config.wrap ? this._items.length - 1 : this._activeIndex;
            }
            this.to(prevIndex);
        }
    }
    
    window.bootstrap.Carousel = Carousel;
    console.log('? Bootstrap.Carousel class registered');
    
    // Auto-initialize carousels
    function initializeCarousels() {
        console.log('?? Looking for carousels to auto-initialize...');
        
        const autoCarousels = document.querySelectorAll('[data-bs-ride="carousel"]');
        console.log(`Found ${autoCarousels.length} auto-init carousels`);
        
        autoCarousels.forEach((element, index) => {
            if (!element._carouselInstance) {
                console.log(`?? Auto-initializing carousel ${index + 1}:`, element.id || 'unnamed');
                new Carousel(element);
            }
        });
        
        // Initialize other carousels with class .carousel
        const otherCarousels = document.querySelectorAll('.carousel:not([data-bs-ride="carousel"])');
        console.log(`Found ${otherCarousels.length} manual carousels`);
        
        otherCarousels.forEach((element, index) => {
            if (!element._carouselInstance) {
                console.log(`?? Manual-initializing carousel ${index + 1}:`, element.id || 'unnamed');
                new Carousel(element);
            }
        });
        
        console.log('?? Carousel initialization complete');
    }
    
    // Multiple initialization strategies
    function safeInitCarousels() {
        try {
            initializeCarousels();
        } catch (error) {
            console.error('Error during carousel initialization:', error);
        }
    }
    
    // Strategy 1: DOM Content Loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', safeInitCarousels);
        console.log('? Waiting for DOMContentLoaded...');
    } else {
        console.log('?? DOM already ready, initializing immediately');
        safeInitCarousels();
    }
    
    // Strategy 2: Window Load (fallback)
    window.addEventListener('load', () => {
        console.log('?? Window load event - reinitializing carousels...');
        safeInitCarousels();
    });
    
    // Strategy 3: Manual initialization with delay
    setTimeout(() => {
        console.log('?? Delayed initialization check...');
        safeInitCarousels();
    }, 1000);
    
    // Also expose manual initialization function
    window.initializeCarousels = safeInitCarousels;
    
    console.log('?? Bootstrap Carousel minimal implementation loaded successfully!');
    
    // Global test function
    window.testBootstrap = function() {
        console.log('?? Bootstrap test function called');
        console.log('Bootstrap object:', window.bootstrap);
        console.log('Carousel class:', window.bootstrap.Carousel);
        return typeof window.bootstrap !== 'undefined' && typeof window.bootstrap.Carousel === 'function';
    };
    
})();