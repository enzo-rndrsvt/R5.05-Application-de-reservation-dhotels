@page "/admin/database/advanced"
@using Microsoft.AspNetCore.Components.Authorization
@using HotelBooking.Web.Services
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@inject IHttpClientFactory HttpClientFactory
@inject ILocalStorageService LocalStorage
@inject IJSRuntime JSRuntime

<PageTitle>Gestion Avancée BDD - Administration</PageTitle>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1>
                <i class="oi oi-hard-drive me-2"></i>
                Gestion Avancée de la Base de Données
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/admin">Administration</a></li>
                    <li class="breadcrumb-item active">Gestion BDD Avancée</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Actions Critiques -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="oi oi-warning me-2"></i>
                        Actions Critiques - Données de Production
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="oi oi-warning"></i>
                        <strong>Attention :</strong> Ces actions affectent directement la base de données de production.
                        Assurez-vous d'avoir une sauvegarde récente avant de procéder.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">?? Nettoyage de Base</h6>
                                </div>
                                <div class="card-body">
                                    <p class="small">Nettoie les données temporaires et les doublons.</p>
                                    <button class="btn btn-warning btn-sm" @onclick="CleanBasicData" disabled="@isProcessing">
                                        <i class="oi oi-brush"></i> Nettoyage Léger
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card border-orange">
                                <div class="card-header" style="background-color: #ff8c00; color: white;">
                                    <h6 class="mb-0">??? Nettoyage Complet</h6>
                                </div>
                                <div class="card-body">
                                    <p class="small">Supprime toutes les données de test et orphelines.</p>
                                    <button class="btn btn-warning" @onclick="DeepCleanData" disabled="@isProcessing">
                                        <i class="oi oi-trash"></i> Nettoyage Complet
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">?? Reset Total</h6>
                                </div>
                                <div class="card-body">
                                    <p class="small text-danger">?? SUPPRIME TOUTES LES DONNÉES !</p>
                                    <button class="btn btn-danger" @onclick="FullReset" disabled="@isProcessing">
                                        <i class="oi oi-ban"></i> RESET COMPLET
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Données SkullKing -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="oi oi-data-transfer-upload me-2"></i>
                        Données SkullKing - Initialisation
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>????? Données Pirates Standard</h6>
                            <p class="text-muted">Crée l'hôtel SkullKing avec 10 chambres de base et des données cohérentes.</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" @onclick="InitSkullKingBasic" disabled="@isProcessing">
                                    <i class="oi oi-plus"></i> Initialiser Données de Base
                                </button>
                                <button class="btn btn-outline-success" @onclick="InitSkullKingComplete" disabled="@isProcessing">
                                    <i class="oi oi-star"></i> Initialiser Données Complètes (25 chambres)
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>?? Statistiques Actuelles</h6>
                            @if (dbStats != null)
                            {
                                <ul class="list-unstyled">
                                    <li><strong>Hôtels :</strong> @dbStats.TotalHotels</li>
                                    <li><strong>Chambres :</strong> @dbStats.TotalRooms</li>
                                    <li><strong>Avec images :</strong> @dbStats.RoomsWithImages</li>
                                    <li><strong>Images multiples :</strong> @dbStats.RoomsWithMultipleImages</li>
                                </ul>
                            }
                            else
                            {
                                <div class="spinner-border spinner-border-sm"></div>
                                <span class="ms-2">Chargement...</span>
                            }
                            
                            <button class="btn btn-sm btn-outline-info mt-2" @onclick="RefreshStats">
                                <i class="oi oi-reload"></i> Actualiser
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Migrations et Maintenance -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="oi oi-cog me-2"></i>
                        Migrations et Schema
                    </h5>
                </div>
                <div class="card-body">
                    <h6>?? Corrections de Schema</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-info" @onclick="FixImageUrlColumn" disabled="@isProcessing">
                            <i class="oi oi-wrench"></i> Corriger Colonne ImageUrl
                        </button>
                        <button class="btn btn-outline-info" @onclick="ValidateSchema" disabled="@isProcessing">
                            <i class="oi oi-check"></i> Valider Schema BDD
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="OptimizeDatabase" disabled="@isProcessing">
                            <i class="oi oi-dashboard"></i> Optimiser Performance
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="oi oi-data-transfer-download me-2"></i>
                        Sauvegarde et Export
                    </h5>
                </div>
                <div class="card-body">
                    <h6>?? Gestion des Sauvegardes</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-secondary" @onclick="CreateBackup" disabled="@isProcessing">
                            <i class="oi oi-data-transfer-download"></i> Créer Sauvegarde
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="ExportData" disabled="@isProcessing">
                            <i class="oi oi-spreadsheet"></i> Export CSV/Excel
                        </button>
                        <button class="btn btn-outline-dark" @onclick="GenerateReport" disabled="@isProcessing">
                            <i class="oi oi-document"></i> Rapport d'État
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs d'Opérations -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="oi oi-list-rich me-2"></i>
                            Journal des Opérations
                        </h5>
                        <button class="btn btn-sm btn-outline-light" @onclick="ClearLogs">
                            <i class="oi oi-trash"></i> Vider
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace;">
                        @if (operationLogs.Any())
                        {
                            @foreach (var log in operationLogs.TakeLast(20))
                            {
                                <div class="mb-1">
                                    <span class="text-muted">[@log.Timestamp.ToString("HH:mm:ss")]</span>
                                    <span class="@GetLogClass(log.Level)">[{@log.Level}]</span>
                                    <span>@log.Message</span>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-muted">Aucune opération effectuée pour le moment...</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool isProcessing = false;
    private List<OperationLog> operationLogs = new();
    private DatabaseStats? dbStats;

    public class DatabaseStats
    {
        public int TotalHotels { get; set; }
        public int TotalRooms { get; set; }
        public int RoomsWithImages { get; set; }
        public int RoomsWithMultipleImages { get; set; }
        public bool SchemaValid { get; set; }
    }

    public class OperationLog
    {
        public DateTime Timestamp { get; set; } = DateTime.Now;
        public string Level { get; set; } = "INFO";
        public string Message { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        LogOperation("INFO", "?? Page de gestion avancée de la BDD chargée");
        await RefreshStats();
    }

    private async Task RefreshStats()
    {
        try
        {
            LogOperation("INFO", "?? Actualisation des statistiques...");
            
            // Simuler le chargement des stats (remplacer par vrais appels API)
            await Task.Delay(1000);
            
            dbStats = new DatabaseStats
            {
                TotalHotels = 2,
                TotalRooms = 25,
                RoomsWithImages = 20,
                RoomsWithMultipleImages = 8,
                SchemaValid = true
            };
            
            LogOperation("SUCCESS", "? Statistiques actualisées");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur lors de l'actualisation: {ex.Message}");
        }
    }

    private async Task CleanBasicData()
    {
        if (!await ConfirmOperation("Nettoyage léger", "Cette opération va supprimer les données temporaires et les doublons."))
            return;

        isProcessing = true;
        LogOperation("WARNING", "?? Début du nettoyage léger...");
        StateHasChanged();

        try
        {
            await Task.Delay(3000); // Simuler l'opération
            LogOperation("SUCCESS", "? Nettoyage léger terminé - Données temporaires supprimées");
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur pendant le nettoyage: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task DeepCleanData()
    {
        if (!await ConfirmOperation("Nettoyage complet", "ATTENTION: Cette opération va supprimer TOUTES les données de test, images orphelines et références invalides."))
            return;

        isProcessing = true;
        LogOperation("WARNING", "??? Début du nettoyage complet...");
        StateHasChanged();

        try
        {
            await Task.Delay(5000); // Simuler l'opération
            LogOperation("SUCCESS", "? Nettoyage complet terminé - Données de test supprimées");
            await RefreshStats();
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur pendant le nettoyage complet: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task FullReset()
    {
        if (!await ConfirmOperation("RESET COMPLET", "?????? DANGER ??????\n\nCette opération va SUPPRIMER TOUTES LES DONNÉES de la base !\n\nHôtels, chambres, réservations, utilisateurs - TOUT sera perdu !\n\nÊtes-vous ABSOLUMENT SÛR ?"))
            return;

        // Double confirmation pour le reset complet
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "DERNIÈRE CHANCE !\n\nTapez 'SUPPRIMER TOUT' si vous voulez vraiment continuer."))
            return;

        isProcessing = true;
        LogOperation("CRITICAL", "?? RESET COMPLET EN COURS - SUPPRESSION DE TOUTES LES DONNÉES !");
        StateHasChanged();

        try
        {
            await Task.Delay(7000); // Simuler l'opération longue
            LogOperation("CRITICAL", "?? RESET COMPLET TERMINÉ - BASE DE DONNÉES VIDE");
            await RefreshStats();
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur pendant le reset: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task InitSkullKingBasic()
    {
        if (!await ConfirmOperation("Données SkullKing de base", "Initialiser l'hôtel SkullKing avec 10 chambres de base ?"))
            return;

        isProcessing = true;
        LogOperation("INFO", "????? Initialisation des données SkullKing de base...");
        StateHasChanged();

        try
        {
            await Task.Delay(4000); // Simuler l'opération
            LogOperation("SUCCESS", "? Hôtel SkullKing créé avec 10 chambres pirates de base");
            await RefreshStats();
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur lors de l'initialisation: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task InitSkullKingComplete()
    {
        if (!await ConfirmOperation("Données SkullKing complètes", "Initialiser l'hôtel SkullKing avec 25 chambres complètes, images multiples et données réalistes ?"))
            return;

        isProcessing = true;
        LogOperation("INFO", "????? Initialisation complète des données SkullKing...");
        StateHasChanged();

        try
        {
            await Task.Delay(8000); // Simuler l'opération longue
            LogOperation("SUCCESS", "? Hôtel SkullKing créé avec 25 chambres, images multiples et données complètes");
            await RefreshStats();
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur lors de l'initialisation complète: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task FixImageUrlColumn()
    {
        isProcessing = true;
        LogOperation("INFO", "?? Correction de la colonne ImageUrl...");
        StateHasChanged();

        try
        {
            await Task.Delay(2000);
            LogOperation("SUCCESS", "? Colonne ImageUrl corrigée et optimisée");
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur correction schema: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task ValidateSchema()
    {
        isProcessing = true;
        LogOperation("INFO", "?? Validation du schéma de base de données...");
        StateHasChanged();

        try
        {
            await Task.Delay(3000);
            LogOperation("SUCCESS", "? Schéma validé - Aucun problème détecté");
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Problèmes de schéma détectés: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task OptimizeDatabase()
    {
        if (!await ConfirmOperation("Optimisation de la base", "Optimiser les index et la performance de la base de données ?"))
            return;

        isProcessing = true;
        LogOperation("INFO", "? Optimisation de la base de données...");
        StateHasChanged();

        try
        {
            await Task.Delay(5000);
            LogOperation("SUCCESS", "? Base de données optimisée - Performance améliorée");
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur optimisation: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task CreateBackup()
    {
        isProcessing = true;
        LogOperation("INFO", "?? Création de sauvegarde en cours...");
        StateHasChanged();

        try
        {
            await Task.Delay(6000);
            var backupName = $"backup_skullking_{DateTime.Now:yyyyMMdd_HHmmss}.sql";
            LogOperation("SUCCESS", $"? Sauvegarde créée: {backupName}");
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur sauvegarde: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task ExportData()
    {
        isProcessing = true;
        LogOperation("INFO", "?? Export des données en cours...");
        StateHasChanged();

        try
        {
            await Task.Delay(4000);
            LogOperation("SUCCESS", "? Export terminé - Fichier CSV généré");
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur export: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task GenerateReport()
    {
        isProcessing = true;
        LogOperation("INFO", "?? Génération du rapport d'état...");
        StateHasChanged();

        try
        {
            await Task.Delay(3000);
            LogOperation("SUCCESS", "? Rapport généré - Toutes les métriques OK");
        }
        catch (Exception ex)
        {
            LogOperation("ERROR", $"? Erreur génération rapport: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task<bool> ConfirmOperation(string operation, string description)
    {
        return await JSRuntime.InvokeAsync<bool>("confirm", $"{operation}\n\n{description}\n\nContinuer ?");
    }

    private void LogOperation(string level, string message)
    {
        operationLogs.Add(new OperationLog { Level = level, Message = message });
        
        // Garder seulement les 100 derniers logs
        if (operationLogs.Count > 100)
        {
            operationLogs.RemoveRange(0, operationLogs.Count - 100);
        }
        
        StateHasChanged();
    }

    private void ClearLogs()
    {
        operationLogs.Clear();
        LogOperation("INFO", "??? Logs vidés");
    }

    private string GetLogClass(string level) => level switch
    {
        "SUCCESS" => "text-success fw-bold",
        "ERROR" => "text-danger fw-bold",
        "WARNING" => "text-warning fw-bold",
        "CRITICAL" => "text-danger fw-bold bg-danger bg-opacity-25 px-1",
        "INFO" => "text-info",
        _ => "text-secondary"
    };
}