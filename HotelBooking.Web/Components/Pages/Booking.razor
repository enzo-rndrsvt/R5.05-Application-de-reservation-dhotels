@page "/booking"
@page "/booking/{RoomId:guid?}"
@using HotelBooking.Web.Models
@using HotelBooking.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject IBookingService BookingService
@inject IHotelService HotelService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Réservation - SkullKing</PageTitle>

<div class="container mt-4">
  <div class="row justify-content-center">
  <div class="col-md-8">
   <div class="card">
     <div class="card-header bg-primary text-white">
   <h3 class="text-center">
      <i class="oi oi-calendar"></i> Réserver votre séjour
   </h3>
 <p class="text-center mb-0">
    <i class="oi oi-home"></i> Embarquez pour une aventure au SkullKing
     </p>
 </div>
     <div class="card-body">

  @if (!string.IsNullOrEmpty(successMessage))
     {
    <div class="alert alert-success">
      <i class="oi oi-circle-check"></i> @successMessage
     </div>
       }

  @if (!string.IsNullOrEmpty(errorMessage))
       {
    <div class="alert alert-danger">
    <i class="oi oi-warning"></i> @errorMessage
            </div>
  }

     @if (rooms == null)
 {
     <div class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
 <span class="visually-hidden">Chargement...</span>
  </div>
     <p class="mt-2">Chargement des chambres disponibles...</p>
    </div>
    }
       else if (!rooms.Any())
         {
   <div class="alert alert-warning">
     <h5><i class="oi oi-warning"></i> Aucune chambre disponible</h5>
     <p>Aucune chambre n'est actuellement disponible pour la réservation.</p>
     <a href="/rooms" class="btn btn-primary">
       <i class="oi oi-grid-three-up"></i> Voir toutes les chambres
   </a>
</div>
   }
   else
      {
     <EditForm Model="@bookingModel" OnValidSubmit="HandleBooking" FormName="BookingForm">
   <DataAnnotationsValidator />

       <div class="row">
<div class="col-md-6">
     <div class="form-group mb-3">
      <label for="startingDate" class="form-label">
  <i class="oi oi-calendar"></i> Date d'arrivée
  </label>
  <InputDate id="startingDate" class="form-control" @bind-Value="bookingModel.StartingDate" @bind-Value:after="OnDatesChanged" />
       <ValidationMessage For="@(() => bookingModel.StartingDate)" class="text-danger" />
    </div>
   </div>

  <div class="col-md-6">
    <div class="form-group mb-3">
     <label for="endingDate" class="form-label">
     <i class="oi oi-calendar"></i> Date de départ
        </label>
    <InputDate id="endingDate" class="form-control" @bind-Value="bookingModel.EndingDate" @bind-Value:after="OnDatesChanged" />
      <ValidationMessage For="@(() => bookingModel.EndingDate)" class="text-danger" />
       </div>
 </div>
     </div>

      <div class="row">
     <div class="col-12">
   <div class="form-group mb-3">
 <label for="roomId" class="form-label">
      <i class="oi oi-home"></i> Chambre sélectionnée
  </label>
  <select id="roomId" class="form-select" @bind="bookingModel.RoomId" @bind:after="OnRoomChanged">
     <option value="">-- Sélectionner une chambre --</option>
   @foreach (var room in rooms)
     {
        <option value="@room.Id">
      Chambre @room.Number - @room.Type 
      (@room.AdultsCapacity adultes, @room.ChildrenCapacity enfants) 
       - @room.PricePerNight.ToString("C")/nuit
   </option>
}
  </select>
 <ValidationMessage For="@(() => bookingModel.RoomId)" class="text-danger" />
   </div>
   </div>
       </div>

         @if (bookingModel.RoomId != Guid.Empty && selectedRoom != null)
    {
           <div class="card bg-light mb-3">
    <div class="card-body">
 <h6><i class="oi oi-info"></i> Détails de la réservation</h6>
      <div class="row">
       <div class="col-md-8">
       <dl class="row mb-0">
     <dt class="col-4">Chambre :</dt>
         <dd class="col-8">@selectedRoom.Number - @selectedRoom.Type</dd>
         
  <dt class="col-4">Capacité :</dt>
     <dd class="col-8">@selectedRoom.AdultsCapacity adultes, @selectedRoom.ChildrenCapacity enfants</dd>
   
    <dt class="col-4">Prix/nuit :</dt>
   <dd class="col-8">@selectedRoom.PricePerNight.ToString("C")</dd>
      
   <dt class="col-4">Nombre de nuits :</dt>
    <dd class="col-8">@bookingModel.NumberOfNights nuit(s)</dd>
      </dl>
  </div>
     <div class="col-md-4 text-end">
 <div class="card bg-primary text-white">
   <div class="card-body text-center">
     <h6>Prix total estimé</h6>
  @if (bookingModel.EstimatedPrice.HasValue)
   {
     <h4>@bookingModel.EstimatedPrice.Value.ToString("C")</h4>
 }
      else
     {
         <div class="spinner-border spinner-border-sm" role="status"></div>
     }
        </div>
 </div>
   </div>
   </div>
     </div>
   </div>
 }

    <div class="d-grid gap-2 mt-4">
      <button type="submit" class="btn btn-success btn-lg" disabled="@isLoading">
      @if (isLoading)
     {
      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
       <span> Réservation en cours...</span>
   }
        else
     {
      <i class="oi oi-calendar"></i> <span>Confirmer la réservation</span>
    }
     </button>

     @* Bouton de debug pour forcer la réservation sans vérification *@
     <button type="button" class="btn btn-warning" @onclick="ForceBooking" disabled="@isLoading">
         @if (isLoading)
         {
             <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
             <span> Réservation forcée...</span>
         }
         else
         {
             <i class="oi oi-flash"></i> <span>Force Réservation (Debug)</span>
         }
     </button>
      
    <div class="row mt-3">
  <div class="col-md-4">
      <a href="/rooms" class="btn btn-outline-primary w-100">
<i class="oi oi-grid-three-up"></i> Autres chambres
     </a>
   </div>
      <div class="col-md-4">
  <a href="/my-bookings" class="btn btn-outline-secondary w-100">
           <i class="oi oi-list"></i> Mes réservations
   </a>
        </div>
    <div class="col-md-4">
     <a href="/" class="btn btn-outline-dark w-100">
     <i class="oi oi-home"></i> Accueil
  </a>
 </div>
   </div>
  </div>
     </EditForm>
       }
  </div>
     </div>
      </div>
  </div>
</div>

@code {
    [Parameter] public Guid? RoomId { get; set; }
    
 [SupplyParameterFromForm]
    private BookingCreation bookingModel { get; set; } = new();
    
     private IEnumerable<Room>? rooms;
  private Room? selectedRoom;
 private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadRooms();
        
  // Si un ID de chambre est passé en paramètre, le sélectionner
   if (RoomId.HasValue)
{
   bookingModel.RoomId = RoomId.Value;
   await OnRoomChanged();
   }
    }

   private async Task LoadRooms()
    {
   try
     {
        // Charger toutes les chambres disponibles depuis l'hôtel SkullKing
     var hotels = await HotelService.GetAllHotelsAsync();
        var skullKingHotel = hotels.FirstOrDefault(h => h.Name.Contains("SkullKing", StringComparison.OrdinalIgnoreCase));
        
      if (skullKingHotel != null)
        {
       rooms = await HotelService.GetHotelRoomsAsync(skullKingHotel.Id, 1, 50);
  }
        else
        {
      errorMessage = "L'hôtel SkullKing n'a pas encore été créé.";
  }
     }
   catch (Exception ex)
    {
    errorMessage = $"Erreur lors du chargement des chambres: {ex.Message}";
     }
  }

 private async Task OnDatesChanged()
    {
   if (bookingModel.RoomId != Guid.Empty && bookingModel.IsValid)
      {
  await CalculatePrice();
    }
 StateHasChanged();
    }

    private async Task OnRoomChanged()
    {
  if (bookingModel.RoomId != Guid.Empty && rooms != null)
     {
    selectedRoom = rooms.FirstOrDefault(r => r.Id == bookingModel.RoomId);
      await CalculatePrice();
  }
  else
 {
    selectedRoom = null;
            bookingModel.EstimatedPrice = null;
 }
      StateHasChanged();
    }

   private async Task CalculatePrice()
    {
     if (selectedRoom != null && bookingModel.IsValid)
        {
    try
    {
            // Effacer le prix précédent pour montrer le chargement
            bookingModel.EstimatedPrice = null;
            StateHasChanged();

   bookingModel.EstimatedPrice = await BookingService.CalculateEstimatedPriceAsync(
    bookingModel.RoomId, 
  bookingModel.StartingDate, 
      bookingModel.EndingDate);
            
            // Vérifier si le calcul a échoué
            if (!bookingModel.EstimatedPrice.HasValue)
            {
                Console.WriteLine("Le calcul du prix a retourné null, utilisation du calcul local");
                // Fallback : calculer localement avec les données disponibles
                int nights = bookingModel.NumberOfNights;
                if (nights > 0)
                {
                    bookingModel.EstimatedPrice = selectedRoom.PricePerNight * nights;
                    Console.WriteLine($"Prix calculé localement: {bookingModel.EstimatedPrice.Value:C} pour {nights} nuits");
                }
                else
                {
                    errorMessage = "Veuillez sélectionner des dates valides.";
                }
            }
            else
            {
                Console.WriteLine($"Prix calculé par l'API: {bookingModel.EstimatedPrice.Value:C} pour {bookingModel.NumberOfNights} nuits");
            }
}
  catch (Exception ex)
    {
    Console.WriteLine($"Erreur lors du calcul du prix: {ex.Message}, utilisation du calcul local");
            
            // Fallback : calculer localement
            try 
            {
                int nights = bookingModel.NumberOfNights;
                if (nights > 0)
                {
                    bookingModel.EstimatedPrice = selectedRoom.PricePerNight * nights;
                    Console.WriteLine($"Prix calculé localement (fallback): {bookingModel.EstimatedPrice.Value:C} pour {nights} nuits");
                }
                else
                {
                    errorMessage = "Veuillez sélectionner des dates valides.";
                    bookingModel.EstimatedPrice = null;
                }
            }
            catch
            {
                errorMessage = $"Impossible de calculer le prix.";
                bookingModel.EstimatedPrice = null;
            }
       }
        }
        else
        {
            // Réinitialiser le prix si les conditions ne sont pas remplies
            bookingModel.EstimatedPrice = null;
        }
        
        StateHasChanged();
}

 private async Task HandleBooking()
  {
    if (!bookingModel.IsValid)
        {
      errorMessage = "Veuillez vérifier les dates sélectionnées.";
     return;
   }

   if (bookingModel.RoomId == Guid.Empty)
     {
  errorMessage = "Veuillez sélectionner une chambre.";
    return;
 }

  errorMessage = string.Empty;
   successMessage = string.Empty;
    isLoading = true;

     try
        {
            // Vérifier la disponibilité de la chambre avec des informations détaillées
            // Si la vérification échoue, on assume que la chambre est disponible (base vide)
            bool canProceed = true;
            string availabilityMessage = "";

            try
            {
                var availabilityInfo = await BookingService.GetRoomAvailabilityInfoAsync(
                    bookingModel.RoomId, 
                    bookingModel.StartingDate, 
                    bookingModel.EndingDate);

                if (availabilityInfo != null)
                {
                    if (!availabilityInfo.IsAvailable)
                    {
                        canProceed = false;
                        availabilityMessage = availabilityInfo.Message;
                        if (availabilityInfo.NextAvailableDate.HasValue)
                        {
                            availabilityMessage += $"\nSuggestion : Essayez à partir du {availabilityInfo.NextAvailableDate.Value:dd/MM/yyyy}.";
                        }
                    }
                }
                else
                {
                    // Si l'API de vérification échoue, on procède quand même
                    Console.WriteLine("API de vérification de disponibilité inaccessible - procédure de réservation maintenue");
                    canProceed = true;
                }
            }
            catch (Exception ex)
            {
                // En cas d'erreur de l'API, on assume que c'est disponible
                Console.WriteLine($"Erreur lors de la vérification de disponibilité: {ex.Message} - procédure de réservation maintenue");
                canProceed = true;
            }

            if (!canProceed)
            {
                errorMessage = availabilityMessage;
                return;
            }

          var result = await BookingService.CreateBookingAsync(bookingModel);

      if (result)
        {
     successMessage = $"Réservation confirmée ! Votre séjour du {bookingModel.StartingDate:dd/MM/yyyy} " +
    $"au {bookingModel.EndingDate:dd/MM/yyyy} dans la chambre {selectedRoom?.Number} a été enregistré. " +
  "Un email de confirmation va vous être envoyé.";
     
      // Réinitialiser le formulaire
  bookingModel = new BookingCreation();
      selectedRoom = null;
  
        // Rediriger vers les réservations après un délai
       await Task.Delay(3000);
    NavigationManager.NavigateTo("/my-bookings");
 }
   else
     {
    errorMessage = "Erreur lors de la création de la réservation. Veuillez réessayer.";
      }
        }
   catch (Exception ex)
     {
    errorMessage = $"Erreur inattendue : {ex.Message}";
     }
   finally
  {
     isLoading = false;
  }
    }

    private async Task ForceBooking()
    {
        if (!bookingModel.IsValid)
        {
            errorMessage = "Veuillez vérifier les dates sélectionnées.";
            return;
        }

        if (bookingModel.RoomId == Guid.Empty)
        {
            errorMessage = "Veuillez sélectionner une chambre.";
            return;
        }

        errorMessage = string.Empty;
        successMessage = string.Empty;
        isLoading = true;

        try
        {
            Console.WriteLine("=== FORCE BOOKING ACTIVÉ - BYPASS DES VÉRIFICATIONS ===");
            
            var result = await BookingService.CreateBookingAsync(bookingModel);

            if (result)
            {
                successMessage = $"?? Réservation FORCÉE confirmée ! Votre séjour du {bookingModel.StartingDate:dd/MM/yyyy} " +
                    $"au {bookingModel.EndingDate:dd/MM/yyyy} dans la chambre {selectedRoom?.Number} a été enregistré. " +
                    "Un email de confirmation va vous être envoyé.";
        
                // Réinitialiser le formulaire
                bookingModel = new BookingCreation();
                selectedRoom = null;
        
                // Rediriger vers les réservations après un délai
                await Task.Delay(3000);
                NavigationManager.NavigateTo("/my-bookings");
            }
            else
            {
                errorMessage = "Erreur lors de la création de la réservation forcée. Vérifiez l'API.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur lors de la réservation forcée : {ex.Message}";
            Console.WriteLine($"Erreur Force Booking: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}