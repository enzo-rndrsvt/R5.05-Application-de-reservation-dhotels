@page "/test-room-images/{roomId:guid}"
@using HotelBooking.Web.Models
@using HotelBooking.Web.Services
@inject IHotelService HotelService
@inject IHttpClientFactory HttpClientFactory
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Test Images Chambre</PageTitle>

<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-info">
            <h3>?? Test Images pour Chambre @RoomId</h3>
        </div>
        <div class="card-body">
            
            @if (room == null)
            {
                <p>Chargement...</p>
            }
            else
            {
                <div class="row">
                    <div class="col-md-6">
                        <h5>Informations de la chambre</h5>
                        <ul>
                            <li><strong>Numéro:</strong> @room.Number</li>
                            <li><strong>Type:</strong> @room.Type</li>
                            <li><strong>ImageUrl:</strong> @(room.ImageUrl ?? "NULL")</li>
                            <li><strong>ImageUrls Count:</strong> @room.ImageUrls.Count</li>
                            <li><strong>AllImageUrls Count:</strong> @room.AllImageUrls.Count</li>
                            <li><strong>HasImages:</strong> @room.HasImages</li>
                        </ul>
                        
                        <h6>URLs d'images détaillées:</h6>
                        @if (room.ImageUrls.Any())
                        {
                            <ol>
                                @foreach (var url in room.ImageUrls)
                                {
                                    <li><code>@url</code></li>
                                }
                            </ol>
                        }
                        else
                        {
                            <p class="text-muted">Aucune URL dans ImageUrls</p>
                        }

                        <div class="mt-3">
                            <button class="btn btn-warning" @onclick="AddTestImagesLocal">
                                ?? Test Local (temporaire)
                            </button>
                            <button class="btn btn-success" @onclick="AddTestImagesAPI" disabled="@isLoading">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                }
                                ?? Test via API (permanent)
                            </button>
                            <button class="btn btn-info" @onclick="DebugRoomData" disabled="@isLoading">
                                ?? Debug Données BDD
                            </button>
                            <a href="/room/@RoomId" class="btn btn-primary">
                                ??? Voir page détails
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Aperçu des images</h5>
                        @if (room.AllImageUrls.Any())
                        {
                            @foreach (var imageUrl in room.AllImageUrls.Take(3))
                            {
                                <div class="mb-2">
                                    <img src="@imageUrl" alt="Test image" 
                                         style="width: 100px; height: 80px; object-fit: cover;" 
                                         class="border rounded" />
                                    <small class="ms-2">@imageUrl</small>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted">Aucune image à afficher</p>
                        }
                    </div>
                </div>
                
                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="alert alert-info mt-3">@message</div>
                }
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid RoomId { get; set; }
    
    private Room? room;
    private string? message;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoom();
    }

    private async Task LoadRoom()
    {
        try
        {
            var hotels = await HotelService.GetAllHotelsAsync();
            
            foreach (var hotel in hotels)
            {
                var rooms = await HotelService.GetHotelRoomsAsync(hotel.Id, 1, 100);
                room = rooms.FirstOrDefault(r => r.Id == RoomId);
                if (room != null) break;
            }
        }
        catch (Exception ex)
        {
            message = $"Erreur: {ex.Message}";
        }
    }

    private void AddTestImagesLocal()
    {
        // Simuler l'ajout d'images de test (en réalité, il faudrait appeler l'API)
        if (room != null)
        {
            var testImages = new List<string>
            {
                "/images/room-test1.jpg",
                "/images/room-test2.jpg", 
                "/images/room-test3.jpg"
            };

            // Pour le test, on modifie temporairement les propriétés (ne persistera pas)
            room.ImageUrls.Clear();
            room.ImageUrls.AddRange(testImages);
            room.ImageUrl = testImages.First();

            message = $"? Images de test ajoutées localement (non persistées). Rechargez pour voir l'effet sur la page détails.";
            StateHasChanged();
        }
    }

    private async Task AddTestImagesAPI()
    {
        if (room == null) return;

        isLoading = true;
        StateHasChanged();

        try
        {
            var httpClient = HttpClientFactory.CreateClient("HotelBookingAPI");
            
            // Ajouter le token d'auth
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = 
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            var response = await httpClient.PostAsync($"api/admin/rooms/{RoomId}/add-test-images", null);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                message = $"? Images ajoutées via API ! Rechargez la page pour voir les changements. Détails: {content}";
                
                // Recharger les données de la chambre
                await LoadRoom();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                message = $"? Erreur API ({response.StatusCode}): {errorContent}";
            }
        }
        catch (Exception ex)
        {
            message = $"? Exception: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task DebugRoomData()
    {
        if (room == null) return;

        isLoading = true;
        StateHasChanged();

        try
        {
            var httpClient = HttpClientFactory.CreateClient("HotelBookingAPI");
            
            // Ajouter le token d'auth
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = 
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            var response = await httpClient.GetAsync($"api/admin/rooms/{RoomId}/debug");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                message = $"?? Debug BDD: {content}";
                Console.WriteLine("=== DEBUG ROOM DATA ===");
                Console.WriteLine(content);
                Console.WriteLine("=== END DEBUG ===");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                message = $"? Erreur debug ({response.StatusCode}): {errorContent}";
            }
        }
        catch (Exception ex)
        {
            message = $"? Exception debug: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}