@page "/admin/configuration"
@page "/admin/config"
@using Microsoft.AspNetCore.Components.Authorization
@using HotelBooking.Web.Services
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@inject IJSRuntime JSRuntime

<PageTitle>Configuration Système - Administration</PageTitle>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1>
                <i class="oi oi-cog me-2"></i>
                Configuration du Système SkullKing
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/admin">Administration</a></li>
                    <li class="breadcrumb-item active">Configuration</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Paramètres Généraux -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="oi oi-home me-2"></i>
                        Paramètres Hôtel
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Nom de l'Hôtel :</label>
                        <input type="text" class="form-control" @bind="hotelName" placeholder="Hôtel SkullKing">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description :</label>
                        <textarea class="form-control" rows="3" @bind="hotelDescription" 
                                placeholder="Le plus grand navire pirate des sept mers..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Évaluation (étoiles) :</label>
                        <select class="form-select" @bind="hotelRating">
                            <option value="3">??? (3 étoiles)</option>
                            <option value="4">???? (4 étoiles)</option>
                            <option value="5">????? (5 étoiles)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contact :</label>
                        <input type="email" class="form-control" @bind="hotelContact" placeholder="contact@skullking.com">
                    </div>
                    <button class="btn btn-primary" @onclick="SaveHotelSettings">
                        <i class="oi oi-check"></i> Sauvegarder
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="oi oi-dollar me-2"></i>
                        Paramètres Tarifaires
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Devise :</label>
                        <select class="form-select" @bind="currency">
                            <option value="EUR">Euro (€)</option>
                            <option value="USD">Dollar ($)</option>
                            <option value="GBP">Livre Sterling (£)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Prix de base par nuit :</label>
                        <div class="input-group">
                            <input type="number" class="form-control" @bind="basePrice" step="0.01" min="0">
                            <span class="input-group-text">@GetCurrencySymbol()</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Coefficient Premium :</label>
                        <input type="number" class="form-control" @bind="premiumMultiplier" step="0.1" min="1">
                        <small class="text-muted">Multiplicateur pour les chambres Premium/Suite</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="taxesIncluded" id="taxesCheck">
                            <label class="form-check-label" for="taxesCheck">
                                Prix TTC (taxes incluses)
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-success" @onclick="SavePricingSettings">
                        <i class="oi oi-check"></i> Sauvegarder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Paramètres d'Images et Carrousels -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="oi oi-image me-2"></i>
                        Configuration Images & Carrousels
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Paramètres d'Images :</h6>
                            <div class="mb-3">
                                <label class="form-label">Nombre max d'images par chambre :</label>
                                <input type="number" class="form-control" @bind="maxImagesPerRoom" min="1" max="10">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Format d'image par défaut :</label>
                                <select class="form-select" @bind="defaultImageFormat">
                                    <option value="jpg">JPEG (.jpg)</option>
                                    <option value="png">PNG (.png)</option>
                                    <option value="webp">WebP (.webp)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Résolution standard :</label>
                                <select class="form-select" @bind="imageResolution">
                                    <option value="800x600">800 × 600 (Standard)</option>
                                    <option value="1024x768">1024 × 768 (Haute)</option>
                                    <option value="1280x960">1280 × 960 (Très Haute)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Paramètres Carrousels :</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="autoplayCarousel" id="autoplayCheck">
                                    <label class="form-check-label" for="autoplayCheck">
                                        Lecture automatique
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Vitesse de transition (ms) :</label>
                                <input type="number" class="form-control" @bind="transitionSpeed" min="100" max="2000" step="100">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Délai auto (secondes) :</label>
                                <input type="number" class="form-control" @bind="autoplayDelay" min="2" max="10">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="showIndicators" id="indicatorsCheck">
                                    <label class="form-check-label" for="indicatorsCheck">
                                        Afficher les indicateurs
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-info" @onclick="SaveImageSettings">
                            <i class="oi oi-check"></i> Sauvegarder
                        </button>
                        <button class="btn btn-outline-info ms-2" @onclick="TestCarouselSettings">
                            <i class="oi oi-play-circle"></i> Tester Carrousels
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="oi oi-shield me-2"></i>
                        Paramètres de Sécurité
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="requireAdminApproval" id="approvalCheck">
                            <label class="form-check-label" for="approvalCheck">
                                Validation admin requise
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="enableDebugMode" id="debugCheck">
                            <label class="form-check-label" for="debugCheck">
                                Mode Debug activé
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="logAllOperations" id="loggingCheck">
                            <label class="form-check-label" for="loggingCheck">
                                Log toutes les opérations
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Niveau de log :</label>
                        <select class="form-select form-select-sm" @bind="logLevel">
                            <option value="Error">Erreurs seulement</option>
                            <option value="Warning">Avertissements</option>
                            <option value="Info">Informations</option>
                            <option value="Debug">Debug complet</option>
                        </select>
                    </div>
                    <button class="btn btn-warning" @onclick="SaveSecuritySettings">
                        <i class="oi oi-check"></i> Sauvegarder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions de Maintenance -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="oi oi-wrench me-2"></i>
                        Actions de Maintenance Rapide
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" @onclick="RestartApplication">
                                    <i class="oi oi-reload"></i> Redémarrer App
                                </button>
                                <button class="btn btn-outline-secondary" @onclick="ClearCache">
                                    <i class="oi oi-trash"></i> Vider Cache
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-info" @onclick="RefreshImages">
                                    <i class="oi oi-image"></i> Actualiser Images
                                </button>
                                <button class="btn btn-outline-success" @onclick="OptimizePerformance">
                                    <i class="oi oi-dashboard"></i> Optimiser
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-warning" @onclick="CheckSystemHealth">
                                    <i class="oi oi-medical-cross"></i> Vérifier Système
                                </button>
                                <button class="btn btn-outline-danger" @onclick="EmergencyMode">
                                    <i class="oi oi-ban"></i> Mode Urgence
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="alert alert-info mb-0 p-2">
                                <small>
                                    <strong>Status :</strong><br/>
                                    <span class="text-success">? Système OK</span><br/>
                                    <span class="text-muted">Dernière vérif. : @lastCheck.ToString("HH:mm")</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sauvegarde des Configuration -->
    <div class="row">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="oi oi-data-transfer-download me-2"></i>
                        Sauvegarde et Restauration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>?? Sauvegarder Configuration :</h6>
                            <p class="text-muted">Exporte tous les paramètres dans un fichier de configuration.</p>
                            <button class="btn btn-success" @onclick="ExportConfiguration">
                                <i class="oi oi-data-transfer-download"></i> Exporter Config
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>?? Restaurer Configuration :</h6>
                            <p class="text-muted">Importe une configuration depuis un fichier.</p>
                            <div class="input-group">
                                <input type="file" class="form-control" accept=".json,.xml,.config">
                                <button class="btn btn-outline-success" @onclick="ImportConfiguration">
                                    <i class="oi oi-data-transfer-upload"></i> Importer
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <h6>?? Actions de Groupe :</h6>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary" @onclick="SaveAllSettings">
                                    <i class="oi oi-check"></i> Tout Sauvegarder
                                </button>
                                <button class="btn btn-outline-warning" @onclick="ResetToDefaults">
                                    <i class="oi oi-reload"></i> Valeurs par Défaut
                                </button>
                                <button class="btn btn-outline-info" @onclick="ValidateAllSettings">
                                    <i class="oi oi-shield"></i> Valider Config
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Paramètres Hôtel
    private string hotelName = "Hôtel SkullKing";
    private string hotelDescription = "Le plus grand navire pirate des sept mers, offrant des cabines de luxe pour les aventuriers en quête de trésors.";
    private int hotelRating = 5;
    private string hotelContact = "contact@skullking.com";

    // Paramètres Tarifaires
    private string currency = "EUR";
    private decimal basePrice = 89.99m;
    private decimal premiumMultiplier = 1.5m;
    private bool taxesIncluded = true;

    // Paramètres Images
    private int maxImagesPerRoom = 5;
    private string defaultImageFormat = "jpg";
    private string imageResolution = "800x600";

    // Paramètres Carrousels
    private bool autoplayCarousel = false;
    private int transitionSpeed = 500;
    private int autoplayDelay = 5;
    private bool showIndicators = true;

    // Paramètres Sécurité
    private bool requireAdminApproval = false;
    private bool enableDebugMode = true;
    private bool logAllOperations = true;
    private string logLevel = "Info";

    // Système
    private DateTime lastCheck = DateTime.Now;

    private async Task SaveHotelSettings()
    {
        await JSRuntime.InvokeVoidAsync("alert", "? Paramètres hôtel sauvegardés !");
    }

    private async Task SavePricingSettings()
    {
        await JSRuntime.InvokeVoidAsync("alert", "? Paramètres tarifaires sauvegardés !");
    }

    private async Task SaveImageSettings()
    {
        await JSRuntime.InvokeVoidAsync("alert", "? Paramètres d'images sauvegardés !");
    }

    private async Task SaveSecuritySettings()
    {
        await JSRuntime.InvokeVoidAsync("alert", "? Paramètres de sécurité sauvegardés !");
    }

    private async Task TestCarouselSettings()
    {
        await JSRuntime.InvokeVoidAsync("alert", $"?? Test carrousel :\nAuto: {autoplayCarousel}\nVitesse: {transitionSpeed}ms\nDélai: {autoplayDelay}s");
    }

    private async Task RestartApplication()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Redémarrer l'application ? Les utilisateurs connectés seront déconnectés.");
        if (confirmed)
        {
            await JSRuntime.InvokeVoidAsync("alert", "?? Application redémarrée (simulation)");
        }
    }

    private async Task ClearCache()
    {
        await JSRuntime.InvokeVoidAsync("alert", "??? Cache vidé - Performance améliorée !");
    }

    private async Task RefreshImages()
    {
        await JSRuntime.InvokeVoidAsync("alert", "??? Images actualisées - Cache d'images régénéré !");
    }

    private async Task OptimizePerformance()
    {
        await JSRuntime.InvokeVoidAsync("alert", "? Performance optimisée - Système accéléré !");
    }

    private async Task CheckSystemHealth()
    {
        await JSRuntime.InvokeVoidAsync("alert", "?? Système vérifié :\n? Base de données : OK\n? Carrousels : OK\n? Images : OK\n? Authentification : OK");
        lastCheck = DateTime.Now;
        StateHasChanged();
    }

    private async Task EmergencyMode()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Activer le mode urgence ? Cela limitera l'accès aux fonctionnalités essentielles.");
        if (confirmed)
        {
            await JSRuntime.InvokeVoidAsync("alert", "?? Mode urgence activé !");
        }
    }

    private async Task ExportConfiguration()
    {
        await JSRuntime.InvokeVoidAsync("alert", "?? Configuration exportée vers 'skullking_config.json' !");
    }

    private async Task ImportConfiguration()
    {
        await JSRuntime.InvokeVoidAsync("alert", "?? Import de configuration - Fonctionnalité en développement");
    }

    private async Task SaveAllSettings()
    {
        await JSRuntime.InvokeVoidAsync("alert", "? Toute la configuration sauvegardée avec succès !");
    }

    private async Task ResetToDefaults()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Restaurer les valeurs par défaut ? Tous les paramètres personnalisés seront perdus.");
        if (confirmed)
        {
            // Réinitialiser aux valeurs par défaut
            hotelName = "Hôtel SkullKing";
            hotelRating = 5;
            basePrice = 89.99m;
            maxImagesPerRoom = 5;
            autoplayCarousel = false;
            enableDebugMode = true;
            
            await JSRuntime.InvokeVoidAsync("alert", "?? Configuration restaurée aux valeurs par défaut !");
            StateHasChanged();
        }
    }

    private async Task ValidateAllSettings()
    {
        await JSRuntime.InvokeVoidAsync("alert", "? Configuration validée :\n? Tous les paramètres sont corrects\n? Aucun conflit détecté\n? Système prêt à fonctionner");
    }

    private string GetCurrencySymbol() => currency switch
    {
        "EUR" => "€",
        "USD" => "$",
        "GBP" => "£",
        _ => "€"
    };
}