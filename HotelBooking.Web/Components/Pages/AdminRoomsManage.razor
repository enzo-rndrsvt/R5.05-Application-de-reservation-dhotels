@page "/admin/rooms"
@page "/admin/rooms/manage"
@using Microsoft.AspNetCore.Components.Authorization
@using HotelBooking.Web.Services
@using HotelBooking.Web.Models
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@inject IHotelService HotelService
@inject IHttpClientFactory HttpClientFactory
@inject ILocalStorageService LocalStorage
@inject IJSRuntime JSRuntime

<PageTitle>Gestion des Chambres - Administration</PageTitle>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>
                        <i class="oi oi-home me-2"></i>
                        Gestion des Cabines Pirates
                    </h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/admin">Administration</a></li>
                            <li class="breadcrumb-item active">Gestion des Chambres</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a href="/admin/rooms/create" class="btn btn-success">
                        <i class="oi oi-plus"></i> Nouvelle Cabine
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres et Recherche -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Rechercher :</label>
                            <input type="text" class="form-control" @bind="searchTerm" @onkeyup="FilterRooms" placeholder="Numéro, type, hôtel...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Hôtel :</label>
                            <select class="form-select" @bind="selectedHotelId" @bind:after="FilterRooms">
                                <option value="">Tous les hôtels</option>
                                @foreach (var hotel in hotels)
                                {
                                    <option value="@hotel.Id">@hotel.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Type :</label>
                            <select class="form-select" @bind="selectedRoomType" @bind:after="FilterRooms">
                                <option value="">Tous les types</option>
                                <option value="Standard">Standard</option>
                                <option value="Premium">Premium</option>
                                <option value="Suite">Suite</option>
                                <option value="Capitaine">Capitaine</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-outline-secondary w-100" @onclick="ResetFilters">
                                <i class="oi oi-reload"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6>Statistiques :</h6>
                    <ul class="list-unstyled mb-0">
                        <li><strong>Total :</strong> @filteredRooms.Count() chambres</li>
                        <li><strong>Avec images :</strong> @filteredRooms.Count(r => r.HasImages)</li>
                        <li><strong>Images multiples :</strong> @filteredRooms.Count(r => r.AllImageUrls.Count > 1)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions en lot -->
    @if (selectedRooms.Any())
    {
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="oi oi-info"></i>
                            <strong>@selectedRooms.Count</strong> chambre(s) sélectionnée(s)
                        </span>
                        <div>
                            <button class="btn btn-sm btn-warning me-2" @onclick="AddTestImagesToSelected">
                                <i class="oi oi-image"></i> Ajouter Images Test
                            </button>
                            <button class="btn btn-sm btn-info me-2" @onclick="TestCarouselsSelected">
                                <i class="oi oi-move"></i> Test Carrousels
                            </button>
                            <button class="btn btn-sm btn-danger" @onclick="DeleteSelected">
                                <i class="oi oi-trash"></i> Supprimer
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="ClearSelection">
                                <i class="oi oi-x"></i> Annuler
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Liste des chambres -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="oi oi-list me-2"></i>
                            Liste des Cabines (@filteredRooms.Count())
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" @onclick="RefreshRooms">
                                <i class="oi oi-reload"></i> Actualiser
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    @if (isLoading)
                    {
                        <div class="text-center p-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="mt-2">Chargement des chambres...</p>
                        </div>
                    }
                    else if (filteredRooms.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>
                                            <input type="checkbox" @onchange="ToggleSelectAll" checked="@allSelected">
                                        </th>
                                        <th>Numéro</th>
                                        <th>Type</th>
                                        <th>Capacité</th>
                                        <th>Prix</th>
                                        <th>Hôtel</th>
                                        <th>Images</th>
                                        <th>État</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var room in filteredRooms.Take(50))
                                    {
                                        <tr class="@(selectedRooms.Contains(room.Id) ? "table-warning" : "")">
                                            <td>
                                                <input type="checkbox" @onchange="(e) => ToggleRoomSelection(room.Id, (bool)e.Value!)" 
                                                       checked="@selectedRooms.Contains(room.Id)">
                                            </td>
                                            <td>
                                                <strong class="text-primary">@room.Number</strong>
                                            </td>
                                            <td>
                                                <span class="badge @GetTypeBadgeClass(room.Type)">@room.Type</span>
                                            </td>
                                            <td>
                                                <i class="oi oi-people"></i> @room.AdultsCapacity
                                                @if (room.ChildrenCapacity > 0)
                                                {
                                                    <span class="text-muted">+ @room.ChildrenCapacity enfants</span>
                                                }
                                            </td>
                                            <td>
                                                <strong>@room.PricePerNight.ToString("C")</strong>
                                            </td>
                                            <td>
                                                @GetHotelName(room.HotelId)
                                            </td>
                                            <td>
                                                @if (room.AllImageUrls.Count > 1)
                                                {
                                                    <span class="badge bg-success">@room.AllImageUrls.Count images</span>
                                                }
                                                else if (room.AllImageUrls.Count == 1)
                                                {
                                                    <span class="badge bg-info">1 image</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">Aucune</span>
                                                }
                                            </td>
                                            <td>
                                                @if (room.HasImages)
                                                {
                                                    <span class="text-success">
                                                        <i class="oi oi-circle-check"></i> OK
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-warning">
                                                        <i class="oi oi-warning"></i> Sans image
                                                    </span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="/room/@room.Id" class="btn btn-outline-primary" title="Voir">
                                                        <i class="oi oi-eye"></i>
                                                    </a>
                                                    <button class="btn btn-outline-warning" @onclick="() => AddTestImages(room.Id)" title="Ajouter images test">
                                                        <i class="oi oi-image"></i>
                                                    </button>
                                                    <button class="btn btn-outline-info" @onclick="() => TestCarousel(room.Id)" title="Test carrousel">
                                                        <i class="oi oi-move"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" @onclick="() => DeleteRoom(room.Id)" title="Supprimer">
                                                        <i class="oi oi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        @if (filteredRooms.Count() > 50)
                        {
                            <div class="p-3 text-center text-muted">
                                <i class="oi oi-info"></i>
                                Affichage des 50 premiers résultats sur @filteredRooms.Count() au total.
                                Utilisez les filtres pour affiner la recherche.
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center p-4">
                            <i class="oi oi-magnifying-glass" style="font-size: 3rem; color: #ccc;"></i>
                            <h5 class="mt-3">Aucune chambre trouvée</h5>
                            <p class="text-muted">Modifiez vos critères de recherche ou créez une nouvelle chambre.</p>
                            <a href="/admin/rooms/create" class="btn btn-primary">
                                <i class="oi oi-plus"></i> Créer une Cabine
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<HotelForUser> hotels = new();
    private List<Room> allRooms = new();
    private IEnumerable<Room> filteredRooms = Enumerable.Empty<Room>();
    
    private string searchTerm = "";
    private string selectedHotelId = "";
    private string selectedRoomType = "";
    private bool isLoading = true;
    
    private HashSet<Guid> selectedRooms = new();
    private bool allSelected = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // Charger les hôtels
            hotels = (await HotelService.GetAllHotelsAsync())?.ToList() ?? new List<HotelForUser>();
            
            // Charger toutes les chambres
            allRooms = new List<Room>();
            foreach (var hotel in hotels)
            {
                var hotelRooms = await HotelService.GetHotelRoomsAsync(hotel.Id, 1, 1000);
                if (hotelRooms != null)
                {
                    allRooms.AddRange(hotelRooms);
                }
            }
            
            FilterRooms();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur chargement données: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void FilterRooms()
    {
        filteredRooms = allRooms.AsEnumerable();

        // Filtre par terme de recherche
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredRooms = filteredRooms.Where(r => 
                r.Number.ToString().Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                r.Type.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                GetHotelName(r.HotelId).Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
            );
        }

        // Filtre par hôtel
        if (!string.IsNullOrWhiteSpace(selectedHotelId) && Guid.TryParse(selectedHotelId, out var hotelId))
        {
            filteredRooms = filteredRooms.Where(r => r.HotelId == hotelId);
        }

        // Filtre par type
        if (!string.IsNullOrWhiteSpace(selectedRoomType))
        {
            filteredRooms = filteredRooms.Where(r => r.Type == selectedRoomType);
        }

        filteredRooms = filteredRooms.OrderBy(r => r.Number);
        StateHasChanged();
    }

    private void ResetFilters()
    {
        searchTerm = "";
        selectedHotelId = "";
        selectedRoomType = "";
        FilterRooms();
    }

    private async Task RefreshRooms()
    {
        selectedRooms.Clear();
        await LoadData();
    }

    private void ToggleRoomSelection(Guid roomId, bool isSelected)
    {
        if (isSelected)
        {
            selectedRooms.Add(roomId);
        }
        else
        {
            selectedRooms.Remove(roomId);
        }
        
        UpdateSelectAllState();
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        bool selectAll = (bool)e.Value!;
        
        selectedRooms.Clear();
        if (selectAll)
        {
            foreach (var room in filteredRooms.Take(50))
            {
                selectedRooms.Add(room.Id);
            }
        }
        
        UpdateSelectAllState();
    }

    private void UpdateSelectAllState()
    {
        var visibleRoomIds = filteredRooms.Take(50).Select(r => r.Id).ToHashSet();
        allSelected = visibleRoomIds.Count > 0 && visibleRoomIds.All(id => selectedRooms.Contains(id));
        StateHasChanged();
    }

    private void ClearSelection()
    {
        selectedRooms.Clear();
        UpdateSelectAllState();
    }

    private async Task AddTestImages(Guid roomId)
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("HotelBookingAPI");
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            if (!string.IsNullOrEmpty(token))
            {
                httpClient.DefaultRequestHeaders.Authorization = 
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            var response = await httpClient.PostAsync($"api/admin/rooms/{roomId}/add-test-images", null);
            
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Images test ajoutées avec succès !");
                await RefreshRooms();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Erreur lors de l'ajout des images test.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Erreur: {ex.Message}");
        }
    }

    private async Task TestCarousel(Guid roomId)
    {
        await JSRuntime.InvokeVoidAsync("alert", $"Test carrousel pour chambre {roomId} - Fonctionnalité en développement");
    }

    private async Task DeleteRoom(Guid roomId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Voulez-vous vraiment supprimer cette chambre ?");
        if (confirmed)
        {
            // TODO: Implémenter suppression
            await JSRuntime.InvokeVoidAsync("alert", "Suppression - Fonctionnalité en développement");
        }
    }

    private async Task AddTestImagesToSelected()
    {
        if (!selectedRooms.Any()) return;
        
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Ajouter des images test aux {selectedRooms.Count} chambres sélectionnées ?");
        if (confirmed)
        {
            foreach (var roomId in selectedRooms)
            {
                await AddTestImages(roomId);
            }
            ClearSelection();
        }
    }

    private async Task TestCarouselsSelected()
    {
        await JSRuntime.InvokeVoidAsync("alert", $"Test des carrousels pour {selectedRooms.Count} chambres - Fonctionnalité en développement");
    }

    private async Task DeleteSelected()
    {
        if (!selectedRooms.Any()) return;
        
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Voulez-vous vraiment supprimer les {selectedRooms.Count} chambres sélectionnées ?");
        if (confirmed)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Suppression multiple - Fonctionnalité en développement");
        }
    }

    private string GetHotelName(Guid hotelId)
    {
        return hotels.FirstOrDefault(h => h.Id == hotelId)?.Name ?? "Hôtel inconnu";
    }

    private string GetTypeBadgeClass(string type) => type.ToLower() switch
    {
        "standard" => "bg-secondary",
        "premium" => "bg-primary", 
        "suite" => "bg-success",
        "capitaine" => "bg-warning text-dark",
        _ => "bg-info"
    };
}